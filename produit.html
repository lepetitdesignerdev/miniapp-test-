<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Fiche produit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    :root{--config-background:url('background.jpg');}

    @font-face{
      font-family:'GTA';
      src:url('hft.ttf') format('truetype');
    }

    body{
      min-height:100vh;
      background-color:#1f1f1f;
      background-image:var(--config-background);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      color:#e0e0e0;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      padding-top:110px;
      padding-bottom:80px;
    }

    header{
      height:120px;
      display:flex;
      align-items:center;
      justify-content:center;
      background-color:rgba(31,31,31,0.2);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(51,51,51,0.2);
      position:fixed;
      top:0;left:0;width:100%;
      z-index:100;
    }
    header a img{height:100px;}
    #back-button{
      position:absolute;left:15px;top:50%;transform:translateY(-50%);
      border-radius:20px;padding:5px 12px;
      background:rgba(40,40,40,0.6);border:1px solid rgba(255,255,255,0.15);
      color:#e0e0e0;font-size:0.85rem;cursor:pointer;
    }

    .container{max-width:960px;margin:0 auto;padding:0 12px;}

    .product-info{
      background:rgba(30,30,30,0.9);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 10px 25px rgba(0,0,0,0.6);
      overflow:hidden;
    }

    /* Cadre média centré, format bloqué */
    #product-media{
      max-width:520px;
      margin:0 auto;
    }
    #product-media img,
    #product-media video{
      width:100%;
      height:260px;
      max-height:260px;
      object-fit:cover;
      display:block;
      background:#000;
      border-radius:8px 8px 0 0;
    }

    .product-info-inner{padding:16px;}

    .product-header-line{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:8px;
    }

    /* Titre principal : nom du produit */
    #product-title{
      font-family:'GTA',sans-serif;
      font-size:1.9rem;
      font-weight:bold;
      margin:0;
    }

    /* Chip catégorie */
    #product-category-chip{
      background-color:rgba(18,18,18,0.85);
      color:#e0e0e0;
      border:1px solid rgba(255,255,255,0.3);
      border-radius:20px;
      padding:5px 12px;
      font-size:0.7rem;
      text-transform:uppercase;
      max-width:40%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Sous-titre : nom du site */
    #product-subtitle{
      font-size:0.9rem;
      font-weight:500;
      margin:4px 0 8px;
      color:#9ca3af;
    }

    #product-description{
      font-size:0.88rem;
      color:#d4d4d4;
      line-height:1.5;
      margin-bottom:12px;
    }

    .options-title{
      font-size:0.9rem;
      text-transform:uppercase;
      letter-spacing:1px;
      color:#a3a3a3;
      margin-bottom:6px;
    }

    .price-options{
      list-style:none;
      padding:0;
      margin:0 0 12px;
    }
    .price-options li{
      margin-bottom:6px;
      padding:6px 10px;
      border-radius:8px;
      background:rgba(15,15,15,0.5);
      border:1px solid rgba(255,255,255,0.1);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.85rem;
    }
    .price-options label{
      display:flex;
      align-items:center;
      gap:6px;
      width:100%;
      cursor:pointer;
    }
    .price-label{flex:1;}
    .price-value{color:#0088cc;font-weight:600;}

    .qty-row{
      margin-bottom:12px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:0.9rem;
    }
    .qty-row input{
      width:70px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #555;
      background:rgba(20,20,20,0.8);
      color:#e5e5e5;
      text-align:center;
    }

    .detail-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
    }
    .btn-main,.btn-secondary{
      display:block;
      width:100%;
      padding:10px 16px;
      border-radius:999px;
      border:none;
      font-size:0.9rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:1px;
      cursor:pointer;
      text-align:center;
      text-decoration:none;
      transition:all .2s ease;
    }
    .btn-main{
      background:#0088cc;
      color:#fff;
    }
    .btn-main:hover{
      background:#0099e6;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.5);
    }
    .btn-secondary{
      background:rgba(40,40,40,0.9);
      color:#e5e5e5;
      border:1px solid rgba(255,255,255,0.2);
    }
    .btn-secondary:hover{
      background:rgba(60,60,60,0.9);
    }

    .info-small{
      margin-top:8px;
      font-size:0.8rem;
      color:#a3a3a3;
      text-align:center;
    }

    @media(max-width:576px){
      header a img{height:90px;}
      #product-title{font-size:1.6rem;}
    }
  </style>
</head>
<body>
  <header>
    <button id="back-button" onclick="history.back()">← Retour</button>
    <a href="index.html">
      <img id="header-logo" src="logo.png" alt="Logo">
    </a>
  </header>

  <div class="container" style="margin-top:10px;">
    <div id="product-box" class="product-info" style="display:none;">
      <div id="product-media"></div>
      <div class="product-info-inner">
        <div class="product-header-line">
          <h1 id="product-title"></h1>
          <div id="product-category-chip"></div>
        </div>

        <div id="product-subtitle"></div>
        <p id="product-description"></p>

        <div class="options-title">Choisir un grammage</div>
        <ul id="price-options" class="price-options"></ul>

        <div class="qty-row">
          <span>Quantité :</span>
          <input type="number" id="qty" min="1" value="1">
        </div>

        <div class="detail-actions">
          <button class="btn-main" id="add-to-cart-btn">Ajouter au panier</button>
          <a href="panier.html" class="btn-secondary">Voir le panier</a>
        </div>

        <div class="info-small">
          Le panier est enregistré sur ton appareil (localStorage).
        </div>
      </div>
    </div>

    <p id="error-msg" style="display:none;text-align:center;margin-top:40px;">
      Produit introuvable.
    </p>
  </div>

  <script>
    let appConfig = {};
    let currentProduct = null;

    // Config (logo, fond, nom du site)
    fetch('config.json?'+Date.now())
      .then(r => r.json())
      .then(cfg => {
        appConfig = cfg || {};
        if (appConfig.catalogBackgroundUrl){
          document.documentElement.style.setProperty(
            '--config-background',
            `url('${appConfig.catalogBackgroundUrl.replace(/'/g,"\\'")}')`
          );
        }
        if (appConfig.logoUrl){
          document.getElementById('header-logo').src = appConfig.logoUrl;
        }
      })
      .catch(()=>{});

    const params = new URLSearchParams(window.location.search);
    const pid = params.get('id');

    // Chargement du produit
    fetch('produits.json?'+Date.now())
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) data = [];
        const prod = data.find(p => String(p.id) === String(pid));
        if (!prod){ showError(); return; }
        renderProduct(prod);
      })
      .catch(err => {
        console.error(err);
        showError();
      });

    function showError(){
      document.getElementById('error-msg').style.display = 'block';
    }

    function renderProduct(p){
      currentProduct = p;
      document.getElementById('product-box').style.display = 'block';

      // MEDIA : vidéo si video_url, sinon image
      const mediaEl = document.getElementById('product-media');
      const videoUrl = p.video_url || '';
      if (videoUrl){
        mediaEl.innerHTML =
          '<video controls playsinline>' +
          '<source src="'+ videoUrl +'" type="video/mp4">' +
          'Votre navigateur ne supporte pas la vidéo.' +
          '</video>';
      }else{
        mediaEl.innerHTML =
          '<img src="'+ (p.image || '') +'" alt="'+ escapeHtml(p.nom || "Produit") +'">';
      }

      // Titre = nom du produit (modifiable dans l’admin)
      document.getElementById('product-title').textContent = p.nom || 'Produit';

      // Sous-titre = nom du site (config)
      document.getElementById('product-subtitle').textContent =
        appConfig.siteName || '';

      // Catégorie
      document.getElementById('product-category-chip').textContent =
        p.categorie || 'Autre';

      // Description
      document.getElementById('product-description').textContent =
        p.description || '';

      // Options de prix
      const list = document.getElementById('price-options');
      list.innerHTML = '';
      const opts = Array.isArray(p.prix_options) ? p.prix_options : [];
      opts.forEach((opt, idx) => {
        const price = Number(opt.prix || 0);
        const label = opt.label || '';
        if (!price || !label) return;
        const id = 'opt_' + idx;
        const li = document.createElement('li');
        li.innerHTML =
          '<label for="'+id+'">' +
          '<input type="radio" name="priceOption" id="'+id+'" value="'+idx+'" '+ (idx===0?'checked':'') +'>' +
          '<span class="price-label">'+ escapeHtml(label) +'</span>' +
          '<span class="price-value">'+ price.toFixed(2) +' €</span>' +
          '</label>';
        list.appendChild(li);
      });

      document.title = (p.nom || 'Produit') + ' - ' + (appConfig.siteName || 'Boutique');
    }

    // Ajouter au panier
    document.getElementById('add-to-cart-btn').addEventListener('click', () => {
      if (!currentProduct) return;

      const radios = document.querySelectorAll('input[name="priceOption"]');
      let selectedIndex = -1;
      radios.forEach(r => { if (r.checked) selectedIndex = parseInt(r.value,10); });
      if (selectedIndex < 0){
        alert('Choisis un grammage.');
        return;
      }

      let qty = parseInt(document.getElementById('qty').value,10);
      if (isNaN(qty) || qty < 1) qty = 1;

      const opt = currentProduct.prix_options[selectedIndex];
      const price = Number(opt.prix || 0);
      const label = opt.label || '';

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const existing = cart.find(it => it.id === currentProduct.id && it.optionLabel === label);

      if (existing){
        existing.qty += qty;
      }else{
        cart.push({
          id: currentProduct.id,
          nom: currentProduct.nom,
          image: currentProduct.image,
          optionLabel: label,
          price: price,
          qty: qty
        });
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      alert('Ajouté au panier !');
    });

    function escapeHtml(str){
      return String(str || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
  </script>
</body>
</html>
