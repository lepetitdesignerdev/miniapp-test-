<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Catalogue</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    :root{
      --config-background:url('background.jpg');
    }

    @font-face{
      font-family:'GTA';
      src:url('hft.ttf') format('truetype');
    }

    body{
      min-height:100vh;
      background-color:#1f1f1f;
      background-image:var(--config-background);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      color:#e0e0e0;
      font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;
      padding-top:125px;
      padding-bottom:110px; /* un peu plus pour bien voir le bouton au-dessus de la nav */
    }

    header{
      height:120px;
      display:flex;
      align-items:center;
      justify-content:center;
      background-color:rgba(31,31,31,0.2);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      color:#e0e0e0;
      padding:0 10px 5px;
      border-bottom:1px solid rgba(51,51,51,0.2);
      position:fixed;
      top:0;left:0;width:100%;
      z-index:100;
    }
    header a img{
      height:100px;
      display:block;
    }
    #back-button{
      position:absolute;
      left:15px;
      top:50%;
      transform:translateY(-50%);
      border-radius:20px;
      padding:5px 12px;
      background:rgba(40,40,40,0.6);
      border:1px solid rgba(255,255,255,0.15);
      color:#e0e0e0;
      font-size:0.85rem;
      cursor:pointer;
      display:none;
    }
    #back-button:hover{
      background-color:rgba(255,255,255,0.15);
    }

    /* Indicateur panier en haut */
    #cart-indicator{
      position:absolute;
      right:15px;
      top:50%;
      transform:translateY(-50%);
      padding:6px 10px;
      border-radius:20px;
      background:rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.25);
      font-size:0.75rem;
      color:#e5e7eb;
      white-space:nowrap;
    }

    .container{
      max-width:960px;
      margin:0 auto;
      padding:0 12px;
    }

    /* üîπ Bulle de bienvenue */
    #welcome-box{
      margin:8px 0 14px;
      padding:8px 14px;
      border-radius:999px;
      background:rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.18);
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
      font-size:0.9rem;
      text-align:center;
      color:#e5e5e5;
    }

    /* Filtres */
    #filters-section{margin-bottom:16px;}
    .filters-row{display:flex;gap:8px;}
    select{
      width:100%;
      border-radius:25px;
      padding:8px 16px;
      border:1px solid #444;
      background-color:#2c2c2c;
      color:#e0e0e0;
      font-size:0.9rem;
    }
    select:focus{
      outline:none;
      border-color:#fcb186;
      box-shadow:0 0 5px rgba(187,134,252,0.5);
    }

    /* Liste produits */
    #product-list{
      display:flex;
      flex-wrap:wrap;
      margin:0 -6px;
    }
    .product-col{
      width:50%;
      padding:0 6px 12px;
    }
    .product-card{
      background:rgba(30,30,30,0.85);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.5);
      padding:10px;
      display:flex;
      flex-direction:column;
      height:100%;
      cursor:pointer;
      transition:transform .2s,box-shadow .2s;
    }
    .product-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 18px rgba(0,0,0,0.7);
    }
    .image-container{
      position:relative;
      margin-bottom:8px;
      border-radius:8px;
      overflow:hidden;
    }
    .product-photo{
      width:100%;
      height:auto;
      display:block;
      aspect-ratio:1;
      object-fit:cover;
    }
    .badge-cat{
      position:absolute;
      top:8px;
      right:8px;
      font-size:0.65rem;
      padding:4px 10px;
      background-color:rgba(18,18,18,0.85);
      color:#e0e0e0;
      border:1px solid rgba(255,255,255,0.3);
      border-radius:20px;
      text-transform:uppercase;
      max-width:70%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .product-card h3{
      font-size:0.95rem;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .product-card p{
      font-size:0.8rem;
      color:#a0a0a0;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .price-preview{
      font-size:0.8rem;
      color:#facc15;
      font-weight:600;
      margin-top:2px;
    }

    /* Vue d√©tail */
    #product-details-view{
      display:none;
      animation:fadeIn .3s ease-in-out;
    }
    .product-info{
      background:rgba(30,30,30,0.9);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.1);
      margin-bottom:40px; /* laisse respirer au-dessus de la nav */
    }

    /* Cadre m√©dia pour image / vid√©o */
    #product-media{
      max-width:520px;
      margin:0 auto;
    }
    #product-media img,
    #product-media video{
      width:100%;
      height:260px;
      max-height:260px;
      object-fit:cover;
      display:block;
      background:#000;
    }

    .product-info-inner{
      padding:16px 16px 90px; /* gros padding bas pour que le bouton soit bien visible */
    }
    .product-header-line{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:8px;
    }

    /* Titre principal : nom du produit */
    #product-farm-display{
      font-family:'GTA',sans-serif;
      font-size:1.9rem;
      font-weight:bold;
      margin:0;
    }

    #product-category-chip{
      background-color:rgba(18,18,18,0.85);
      color:#e0e0e0;
      border:1px solid rgba(255,255,255,0.3);
      border-radius:20px;
      padding:5px 12px;
      font-size:0.7rem;
      text-transform:uppercase;
      white-space:nowrap;
      max-width:40%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Sous-titre */
    #product-name-display{
      list-style:none;
      padding-left:0;
      margin:4px 0 10px;
      font-size:0.9rem;
      color:#9ca3af;
    }
    #product-name-display li{
      position:relative;
      padding-left:0.7em;
      margin-bottom:2px;
    }
    #product-name-display li::before{
      content:"‚Ä¢";
      position:absolute;
      left:0;
      color:#0088cc;
    }

    #product-description{
      font-size:0.85rem;
      color:#a0a0a0;
      line-height:1.5;
      margin-bottom:12px;
      display:none;
    }

    /* Grammages style pill moderne */
    #product-prices{
      list-style:none;
      padding:0;
      margin:0 0 10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    #product-prices li{
      border-radius:30px;
      border:1px solid rgba(0,136,204,0.25);
      padding:6px 14px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.85rem;
      transition:all .2s ease;
      background:rgba(10,10,10,0.7);
      cursor:pointer;
    }
    #product-prices li input[type="radio"]{
      display:none; /* on cache les radios, on garde que les pill visuelles */
    }
    .price-option-selected{
      border-color:rgba(0,136,204,0.9);
      background:rgba(0,136,204,0.18);
      box-shadow:0 3px 10px rgba(0,0,0,0.6);
    }
    .price-weight{color:#e5e5e5;opacity:.9;}
    .price-value{color:#facc15;font-weight:600;}

    .detail-qty-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin:8px 0 10px;
      font-size:0.9rem;
    }
    .detail-qty-row input{
      width:70px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #555;
      background:rgba(20,20,20,0.8);
      color:#e5e5e5;
      text-align:center;
    }

    .detail-actions{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .detail-btn{
      display:block;width:100%;
      padding:10px 16px;
      border-radius:999px;
      border:none;
      background:#0088cc;
      color:#fff;
      font-size:0.9rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:1px;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
      transition:all .2s ease;
    }
    .detail-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.5);
      background:#0099e6;
    }
    .detail-btn-secondary{
      background:rgba(40,40,40,0.9);
    }
    .detail-btn-secondary:hover{
      background:rgba(60,60,60,0.9);
    }

    /* Nav bas type moustachos */
    .bottom-nav{
      position:fixed;
      bottom:0;left:0;right:0;
      background:rgba(30,30,30,0.95);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,0.1);
      padding:10px 0 12px;
      z-index:1000;
      display:flex;
      justify-content:space-around;
      align-items:center;
    }
    .nav-item{
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:0.7rem;
      color:#a0a0a0;
      text-decoration:none;
      padding:6px 10px;
      border-radius:8px;
      transition:all .2s ease;
    }
    .nav-item span.icon{
      font-size:1.3rem;
      margin-bottom:3px;
    }
    .nav-item:hover{
      color:#0088cc;
      background:rgba(255,255,255,0.05);
    }
    .nav-item.active{color:#0088cc;}

    /* Page infos */
    #info-page{
      display:none;
      max-width:960px;
      margin:0 auto;
      padding:16px 12px 80px;
    }
    .info-card{
      background:rgba(30,30,30,0.9);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 10px 25px rgba(0,0,0,0.6);
      padding:18px 16px 20px;
      text-align:left;
    }
    .info-card h2{
      font-family:'GTA',sans-serif;
      font-size:1.4rem;
      margin-bottom:10px;
      color:#0088cc;
    }
    .info-card p{
      font-size:0.9rem;
      line-height:1.5;
      margin-bottom:8px;
      color:#e5e5e5;
    }
    .info-contact-btn{
      display:inline-block;
      margin-top:12px;
      padding:10px 18px;
      border-radius:999px;
      background:#0088cc;
      color:#fff;
      font-size:0.9rem;
      font-weight:600;
      text-decoration:none;
      text-align:center;
      white-space:nowrap;
    }
    .info-contact-btn:hover{
      background:#0099e6;
    }

    #initial-loading{
      text-align:center;
      width:100%;
      margin:20px 0;
      font-size:0.9rem;
    }

    /* üîπ CHAT PAGE */
    #chat-page{
      display:none;
      max-width:960px;
      margin:0 auto;
      padding:16px 12px 80px;
    }
    .chat-card{
      background:rgba(30,30,30,0.9);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 10px 25px rgba(0,0,0,0.6);
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      height:calc(100vh - 190px);
      max-height:520px;
    }
    .chat-card h2{
      font-size:1rem;
      margin-bottom:6px;
    }
    #chat-messages{
      flex:1;
      overflow-y:auto;
      margin-bottom:8px;
      font-size:0.85rem;
    }
    .chat-line{
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin-bottom:6px;
    }
    .chat-avatar{
      width:32px;
      height:32px;
      border-radius:50%;
      overflow:hidden;
      background:#020617;
      flex-shrink:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.7rem;
      color:#e5e5e5;
    }
    .chat-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .chat-bubble{
      background:rgba(15,23,42,0.9);
      border-radius:10px;
      padding:6px 8px;
      border:1px solid rgba(55,65,81,0.8);
      max-width:80%;
    }
    .chat-bubble.self{
      background:rgba(8,47,73,0.95);
      border-color:rgba(56,189,248,0.7);
    }
    .chat-user-line{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:0.75rem;
      margin-bottom:2px;
      color:#9ca3af;
    }
    .chat-text{
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    #chat-input-row{
      display:flex;
      gap:6px;
      margin-top:4px;
    }
    #chat-input{
      flex:1;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      color:#e5e5e5;
      font-size:0.85rem;
    }
    #chat-send{
      padding:7px 12px;
      border-radius:999px;
      border:none;
      background:#0088cc;
      color:#f9fafb;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
    }
    #chat-send:hover{
      background:#0099e6;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(16px);}
      to{opacity:1;transform:translateY(0);}
    }

    @media(max-width:576px){
      body{
        background-size:auto;
        background-repeat:repeat;
        background-position: center;
      }
      header a img{height:90px;}
      #product-farm-display{font-size:1.6rem;}
    }
    @media(min-width:900px){
      .product-col{width:33.333%;}
    }
  </style>
</head>
<body>
  <!-- nav bas -->
  <nav class="bottom-nav">
    <a href="#" class="nav-item active" id="nav-menu">
      <span class="icon">üè†</span><span>Menu</span>
    </a>
    <a href="#" class="nav-item" id="nav-info">
      <span class="icon">‚ÑπÔ∏è</span><span>Infos</span>
    </a>
    <!-- üîπ Tab Chat ajout√© -->
    <a href="#" class="nav-item" id="nav-chat">
      <span class="icon">üí¨</span><span>Chat</span>
    </a>
    <a href="panier.html" class="nav-item" id="nav-panier">
      <span class="icon">üß∫</span><span>Panier</span>
    </a>
    <a href="#" class="nav-item" id="nav-contact" target="_blank">
      <span class="icon">‚úâÔ∏è</span><span>Contact</span>
    </a>
  </nav>

  <!-- header -->
  <header>
    <button id="back-button">‚Üê Retour</button>
    <a href="index.html">
      <img id="header-logo" src="logo.png" alt="Logo">
    </a>
    <div id="cart-indicator">Panier : 0 ‚Ä¢ 0,00 ‚Ç¨</div>
  </header>

  <!-- page catalogue -->
  <div id="main-page">
    <div class="container">
      <!-- üîπ Bulle bienvenue sous le logo -->
      <div id="welcome-box">Bienvenue üëã</div>

      <div id="filters-section">
        <div class="filters-row">
          <select id="category-filter">
            <option value="">Toutes les cat√©gories</option>
          </select>
          <select id="farm-filter">
            <option value="">Tous les producteurs</option>
          </select>
        </div>
      </div>

      <!-- liste produits -->
      <div id="products-view">
        <div id="product-list">
          <div id="initial-loading">Chargement des produits...</div>
        </div>
      </div>

      <!-- vue d√©tail -->
      <div id="product-details-view">
        <div class="product-info">
          <div id="product-media"></div>
          <div class="product-info-inner">
            <div class="product-header-line">
              <h1 id="product-farm-display"></h1>
              <div id="product-category-chip"></div>
            </div>
            <ul id="product-name-display"></ul>
            <p id="product-description"></p>
            <ul id="product-prices"></ul>

            <div class="detail-qty-row">
              <span>Quantit√© :</span>
              <input type="number" id="detail-qty" min="1" value="1">
            </div>

            <div class="detail-actions">
              <button type="button" id="detail-add-to-cart-btn" class="detail-btn">
                Ajouter au panier
              </button>
              <a href="panier.html" class="detail-btn detail-btn-secondary">
                Voir le panier
              </a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- page infos -->
  <div id="info-page">
    <div class="info-card">
      <h2>Informations</h2>
      <div id="info-content"></div>
      <a href="#" id="info-contact-btn" class="info-contact-btn">
        üí¨ Contacter sur Telegram
      </a>
    </div>
  </div>

  <!-- üîπ page chat -->
  <div id="chat-page">
    <div class="chat-card">
      <h2>Chat clients</h2>
      <div id="chat-messages"></div>
      <div id="chat-input-row">
        <input type="text" id="chat-input" placeholder="√âcrire un message...">
        <button id="chat-send">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- SDK Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    const headerLogoEl   = document.getElementById('header-logo');
    const navContactEl   = document.getElementById('nav-contact');
    const backButtonEl   = document.getElementById('back-button');
    const filtersSection = document.getElementById('filters-section');
    const productsView   = document.getElementById('products-view');
    const productListEl  = document.getElementById('product-list');
    const detailsView    = document.getElementById('product-details-view');
    const infoPageEl     = document.getElementById('info-page');
    const mainPageEl     = document.getElementById('main-page');
    const cartIndicatorEl= document.getElementById('cart-indicator');
    const infoContactBtn = document.getElementById('info-contact-btn');
    const welcomeBoxEl   = document.getElementById('welcome-box');

    const categoryFilterEl = document.getElementById('category-filter');
    const farmFilterEl     = document.getElementById('farm-filter');

    const productMediaEl        = document.getElementById('product-media');
    const productFarmDisplayEl  = document.getElementById('product-farm-display');
    const productCategoryChipEl = document.getElementById('product-category-chip');
    const productNameDisplayEl  = document.getElementById('product-name-display');
    const productDescriptionEl  = document.getElementById('product-description');
    const productPricesEl       = document.getElementById('product-prices');
    const detailQtyInput        = document.getElementById('detail-qty');
    const detailAddToCartBtn    = document.getElementById('detail-add-to-cart-btn');

    const navMenuEl  = document.getElementById('nav-menu');
    const navInfoEl  = document.getElementById('nav-info');
    const navChatEl  = document.getElementById('nav-chat');

    const chatPageEl     = document.getElementById('chat-page');
    const chatMessagesEl = document.getElementById('chat-messages');
    const chatInputEl    = document.getElementById('chat-input');
    const chatSendEl     = document.getElementById('chat-send');

    let appConfig = {};
    let masterProducts = [];
    let allProducts = [];
    let displayedProducts = 0;
    const PRODUCTS_PER_BATCH = 20;
    let isLoading = false;
    let currentDetailProduct = null;
    let currentDetailPriceIndex = 0;

    // üîπ objet user Telegram global pour le chat
    const telegramUser = {
      id: '',
      username: '',
      first_name: '',
      last_name: '',
      photo_url: ''
    };

    function isTelegramLogged(){
      return !!telegramUser.id;
    }

    function getTelegramDisplayName(){
      const full = [telegramUser.first_name, telegramUser.last_name].filter(Boolean).join(' ').trim();
      if(full) return full;
      if(telegramUser.username) return '@'+telegramUser.username;
      return 'Client';
    }

    // üîπ Bienvenue + r√©cup√©ration Telegram user
    (function initTelegramWelcome(){
      if(!welcomeBoxEl) return;
      try{
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if(!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user){
          welcomeBoxEl.textContent = 'Bienvenue üëã';
          return;
        }
        const u = tg.initDataUnsafe.user;
        telegramUser.id         = String(u.id || '');
        telegramUser.username   = u.username || '';
        telegramUser.first_name = u.first_name || '';
        telegramUser.last_name  = u.last_name || '';
        telegramUser.photo_url  = u.photo_url || '';

        const username = u.username ? '@'+u.username : '';
        const fullName = [u.first_name, u.last_name].filter(Boolean).join(' ');
        const display  = fullName || username || 'client';
        welcomeBoxEl.textContent = 'Bienvenue ' + display + ' üëã';
      }catch(e){
        welcomeBoxEl.textContent = 'Bienvenue üëã';
      }
    })();

    // Si pas connect√© Telegram -> on masque le tab Chat
    (function hideChatIfNotTelegram(){
      if(!isTelegramLogged() && navChatEl){
        navChatEl.style.display = 'none';
      }
    })();

    // CONFIG
    fetch('config.json?'+Date.now())
      .then(r=>r.json())
      .then(cfg=>{
        appConfig = cfg || {};
        if(appConfig.catalogBackgroundUrl){
          document.documentElement.style.setProperty(
            '--config-background',
            `url('${appConfig.catalogBackgroundUrl.replace(/'/g,"\\'")}')`
          );
        }
        if(appConfig.logoUrl){
          headerLogoEl.src = appConfig.logoUrl;
        }
        if(appConfig.telegramContactUrl){
          navContactEl.href = appConfig.telegramContactUrl;
          if(infoContactBtn){
            infoContactBtn.href = appConfig.telegramContactUrl;
            infoContactBtn.style.display = 'inline-block';
          }
        }else{
          navContactEl.href = '#';
          if(infoContactBtn){
            infoContactBtn.style.display = 'none';
          }
        }
        loadProducts();
        loadInfoContent();
        updateCartIndicator();
      })
      .catch(()=>{
        loadProducts();
        loadInfoContent();
        updateCartIndicator();
      });

    // PRODUITS
    function loadProducts(){
      fetch('produits.json?'+Date.now())
        .then(r=>r.json())
        .then(data=>{
          if(!Array.isArray(data)) data=[];
          masterProducts = data.map(p=>transformProduct(p));
          masterProducts.sort((a,b)=>(b.id||0)-(a.id||0));
          allProducts=[...masterProducts];
          displayedProducts=0;
          productListEl.innerHTML='';
          updateFilters();
          loadMoreProducts();
        })
        .catch(err=>{
          console.error(err);
          productListEl.innerHTML='<div id="initial-loading">Erreur de chargement des produits.</div>';
        });
    }

    function transformProduct(p){
      const prixOptions = Array.isArray(p.prix_options)?p.prix_options:[];
      return {
        id: p.id || 0,
        categorie: p.categorie || 'Autre',
        // üîπ producteur du produit prioritaire
        farm: p.farm || p.producteur || p.producer || appConfig.siteName || 'Ma boutique',
        nom: p.nom || 'Produit',
        description: p.description || '',
        image: p.image || 'https://via.placeholder.com/600x600?text=Produit',
        video_url: p.video_url || '',
        prixOptions: prixOptions
      };
    }

    // FILTRES
    function updateFilters(){
      const categories=new Set();
      const farms=new Set();
      masterProducts.forEach(p=>{
        categories.add(p.categorie);
        farms.add(p.farm);
      });
      categoryFilterEl.innerHTML='<option value="">Toutes les cat√©gories</option>';
      categories.forEach(cat=>{
        categoryFilterEl.innerHTML+=`<option value="${cat.toLowerCase()}">${cat}</option>`;
      });
      farmFilterEl.innerHTML='<option value="">Tous les producteurs</option>';
      farms.forEach(f=>{
        farmFilterEl.innerHTML+=`<option value="${f.toLowerCase()}">${f}</option>`;
      });
    }

    function applyFilters(){
      const cat=categoryFilterEl.value.toLowerCase();
      const farm=farmFilterEl.value.toLowerCase();
      allProducts=masterProducts.filter(p=>{
        const mCat=!cat||p.categorie.toLowerCase()===cat;
        const mFarm=!farm||p.farm.toLowerCase()===farm;
        return mCat&&mFarm;
      });
      displayedProducts=0;
      productListEl.innerHTML='';
      loadMoreProducts();
    }

    categoryFilterEl.addEventListener('change',applyFilters);
    farmFilterEl.addEventListener('change',applyFilters);

    // LISTE
    async function loadMoreProducts(){
      if(isLoading||displayedProducts>=allProducts.length) return;
      isLoading=true;

      const start=displayedProducts;
      const end=Math.min(start+PRODUCTS_PER_BATCH,allProducts.length);
      const slice=allProducts.slice(start,end);

      if(start===0){
        productListEl.innerHTML='<div id="initial-loading">Chargement des produits...</div>';
      }

      const initial=document.getElementById('initial-loading');
      if(initial && start>0) initial.remove();

      for(const prod of slice){
        const col=document.createElement('div');
        col.className='product-col';
        col.dataset.id=prod.id;

        let minPrice='';
        if(prod.prixOptions.length){
          const vals=prod.prixOptions
            .map(o=>Number(o.prix||o.price||0))
            .filter(v=>!isNaN(v)&&v>0);
          if(vals.length){
            const mp=Math.min(...vals);
            minPrice=mp.toFixed(2)+' ‚Ç¨';
          }
        }

        col.innerHTML=`
          <div class="product-card">
            <div class="image-container">
              <img src="${prod.image}" alt="${escapeHtml(prod.nom)}" class="product-photo" loading="lazy">
              <span class="badge-cat">${escapeHtml(prod.categorie)}</span>
            </div>
            <h3>${escapeHtml(prod.nom)}</h3>
            <p>${escapeHtml(prod.farm)}</p>
            <div class="price-preview">${minPrice ? '√Ä partir de '+minPrice : '&nbsp;'}</div>
          </div>
        `;
        col.addEventListener('click',()=>showProductDetails(prod.id));
        productListEl.appendChild(col);
      }

      const init=document.getElementById('initial-loading');
      if(init) init.remove();

      displayedProducts=end;
      isLoading=false;
    }

    window.addEventListener('scroll',()=>{
      if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200){
        loadMoreProducts();
      }
    });

    // DETAIL
    function showProductDetails(id){
      const prod=masterProducts.find(p=>p.id==id);
      if(!prod) return;

      currentDetailProduct = prod;

      productsView.style.display='none';
      filtersSection.style.display='none';
      detailsView.style.display='block';
      mainPageEl.style.display='block';
      infoPageEl.style.display='none';
      chatPageEl.style.display='none';
      backButtonEl.style.display='inline-block';

      // Titre = nom du produit
      productFarmDisplayEl.textContent=prod.nom;
      // Cat√©gorie
      productCategoryChipEl.textContent=prod.categorie;

      // Sous-titre = producteur du produit (puis fallback site)
      productNameDisplayEl.innerHTML='';
      const li=document.createElement('li');
      li.textContent = prod.farm || appConfig.siteName || '';
      productNameDisplayEl.appendChild(li);

      if(prod.description && prod.description.trim()!==''){
        productDescriptionEl.style.display='block';
        productDescriptionEl.textContent=prod.description;
      }else{
        productDescriptionEl.style.display='none';
        productDescriptionEl.textContent='';
      }

      // prix / grammages style pill
      productPricesEl.innerHTML='';
      currentDetailPriceIndex = 0;
      prod.prixOptions.forEach((opt,idx)=>{
        const price=Number(opt.prix||opt.price||0);
        const label=opt.label||'';
        if(!price||!label) return;
        const li=document.createElement('li');
        li.className = 'price-option' + (idx===0 ? ' price-option-selected' : '');
        li.dataset.index = idx;
        li.innerHTML=`
          <span class="price-weight">${escapeHtml(label)}</span>
          <span class="price-value">${price.toFixed(2)} ‚Ç¨</span>
        `;
        li.addEventListener('click', ()=>selectDetailPrice(idx));
        productPricesEl.appendChild(li);
      });

      // image ou vid√©o
      if(prod.video_url){
        productMediaEl.innerHTML = `
          <video src="${prod.video_url}" autoplay muted playsinline loop controls></video>
        `;
      }else{
        productMediaEl.innerHTML=`
          <img src="${prod.image}" alt="${escapeHtml(prod.nom)}">
        `;
      }

      // reset quantit√©
      detailQtyInput.value = 1;

      window.scrollTo(0,0);
      window.history.pushState({productId:id},'', '?id='+encodeURIComponent(id));
    }

    function selectDetailPrice(idx){
      currentDetailPriceIndex = idx;
      document.querySelectorAll('#product-prices li').forEach(li=>{
        const i = parseInt(li.dataset.index,10);
        li.classList.toggle('price-option-selected', i===idx);
      });
    }

    function showProductsList(){
      detailsView.style.display='none';
      productsView.style.display='block';
      filtersSection.style.display='block';
      infoPageEl.style.display='none';
      chatPageEl.style.display='none';
      mainPageEl.style.display='block';
      backButtonEl.style.display='none';
      window.history.pushState({},'','index.html');
      currentDetailProduct = null;
    }

    backButtonEl.addEventListener('click',showProductsList);

    window.addEventListener('popstate',e=>{
      if(e.state && e.state.productId){
        showProductDetails(e.state.productId);
      }else{
        showProductsList();
      }
    });

    // Ajouter au panier depuis la vue d√©tail
    detailAddToCartBtn.addEventListener('click', ()=>{
      if(!currentDetailProduct || !currentDetailProduct.prixOptions.length){
        alert('Aucun grammage disponible.');
        return;
      }

      const opt = currentDetailProduct.prixOptions[currentDetailPriceIndex] || currentDetailProduct.prixOptions[0];

      let qty=parseInt(detailQtyInput.value,10);
      if(isNaN(qty)||qty<1) qty=1;

      const price=Number(opt.prix||opt.price||0);
      const label=opt.label||'';

      const cart=JSON.parse(localStorage.getItem('cart')||'[]');
      const existing=cart.find(it=>it.id===currentDetailProduct.id && it.optionLabel===label);
      if(existing){
        existing.qty+=qty;
      }else{
        cart.push({
          id: currentDetailProduct.id,
          nom: currentDetailProduct.nom,
          image: currentDetailProduct.image,
          optionLabel: label,
          price: price,
          qty: qty
        });
      }
      localStorage.setItem('cart',JSON.stringify(cart));
      updateCartIndicator();
      alert('Ajout√© au panier !');
    });

    // Indicateur panier haut de page
    function updateCartIndicator(){
      let cart=[];
      try{
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
      }catch(e){
        cart=[];
      }
      if(!cart.length){
        cartIndicatorEl.textContent = 'Panier : 0 ‚Ä¢ 0,00 ‚Ç¨';
        return;
      }
      let qty=0,total=0;
      cart.forEach(it=>{
        const q = Number(it.qty||0);
        const p = Number(it.price||0);
        qty += q;
        total += q*p;
      });
      cartIndicatorEl.textContent = 'Panier : '+qty+' ‚Ä¢ '+total.toFixed(2)+' ‚Ç¨';
    }

    // INFOS
    function loadInfoContent(){
      fetch('informations.txt?'+Date.now())
        .then(r=>r.text())
        .then(text=>{
          const infoContent=document.getElementById('info-content');
          if(!text.trim()){
            const t=(appConfig.infoText || 'Clique sur un produit pour voir les informations et les prix.');
            infoContent.innerHTML='<p>'+escapeHtml(t)+'</p>';
            return;
          }
          const sections=text.split('\n\n').filter(s=>s.trim());
          infoContent.innerHTML=sections.map(s=>{
            const withBold=s.replace(/\*(.*?)\*/g,'<strong>$1</strong>');
            return '<p>'+withBold.replace(/\n/g,'<br>')+'</p>';
          }).join('');
        })
        .catch(()=>{
          const infoContent=document.getElementById('info-content');
          const t=(appConfig.infoText || 'Clique sur un produit pour voir les informations et les prix.');
          infoContent.innerHTML='<p>'+escapeHtml(t)+'</p>';
        });
    }

    // Nav bas (Menu / Infos / Chat)
    navMenuEl.addEventListener('click',e=>{
      e.preventDefault();
      document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
      navMenuEl.classList.add('active');
      infoPageEl.style.display='none';
      chatPageEl.style.display='none';
      mainPageEl.style.display='block';
    });
    navInfoEl.addEventListener('click',e=>{
      e.preventDefault();
      document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
      navInfoEl.classList.add('active');
      mainPageEl.style.display='none';
      chatPageEl.style.display='none';
      infoPageEl.style.display='block';
      backButtonEl.style.display='none';
    });
    if(navChatEl){
      navChatEl.addEventListener('click',e=>{
        e.preventDefault();
        if(!isTelegramLogged()){
          alert('Le chat est r√©serv√© aux utilisateurs connect√©s via la mini-app Telegram.');
          return;
        }
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
        navChatEl.classList.add('active');
        mainPageEl.style.display='none';
        infoPageEl.style.display='none';
        detailsView.style.display='none';
        filtersSection.style.display='none';
        backButtonEl.style.display='none';
        chatPageEl.style.display='block';
        loadChatMessages();
      });
    }

    function escapeHtml(str){
      return String(str||'')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // üîπ CHAT : helpers
    function renderAvatar(url,name){
      if(url){
        return '<div class="chat-avatar"><img src="'+url+'" alt=""></div>';
      }
      const initials = String(name||'?')
        .split(' ')
        .filter(Boolean)
        .map(x=>x[0])
        .join('')
        .substring(0,2)
        .toUpperCase();
      return '<div class="chat-avatar">'+initials+'</div>';
    }

    function loadChatMessages(){
      fetch('chat.php?action=list')
        .then(r=>r.json())
        .then(data=>{
          if(!data || !data.ok || !Array.isArray(data.messages)) return;
          chatMessagesEl.innerHTML = '';
          data.messages.forEach(m=>{
            const name = m.user || 'Client';
            const text = m.text || '';
            const time = m.time || '';
            const uid  = m.uid  || '';
            const photo= m.photo_url || '';
            const self = (uid === telegramUser.id);
            const bubbleClass = self ? 'chat-bubble self' : 'chat-bubble';
            chatMessagesEl.innerHTML += `
              <div class="chat-line">
                ${renderAvatar(photo,name)}
                <div class="${bubbleClass}">
                  <div class="chat-user-line">
                    <span>${escapeHtml(name)}</span>
                    <span>${escapeHtml(time)}</span>
                  </div>
                  <div class="chat-text">${escapeHtml(text)}</div>
                </div>
              </div>
            `;
          });
          chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        })
        .catch(()=>{});
    }

    function sendChatMessage(){
      const txt = chatInputEl.value.trim();
      if(!txt) return;
      if(!isTelegramLogged()){
        alert('Tu dois ouvrir cette page via Telegram pour utiliser le chat.');
        return;
      }
      const payload = {
        user: getTelegramDisplayName(),
        uid: telegramUser.id,
        photo_url: telegramUser.photo_url,
        text: txt
      };
      fetch('chat.php?action=send',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(res=>{
        if(res && res.ok){
          chatInputEl.value='';
          loadChatMessages();
        }
      })
      .catch(()=>{});
    }

    chatSendEl.addEventListener('click',sendChatMessage);
    chatInputEl.addEventListener('keydown',e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        sendChatMessage();
      }
    });

    // refresh auto du chat toutes les 4s quand la page chat est visible
    setInterval(()=>{
      if(chatPageEl.style.display==='block'){
        loadChatMessages();
      }
    },4000);

    // si URL a d√©j√† ?id
    (function checkInitialId(){
      const params=new URLSearchParams(window.location.search);
      const pid=params.get('id');
      if(pid){
        const interval=setInterval(()=>{
          if(masterProducts.length){
            clearInterval(interval);
            showProductDetails(pid);
          }
        },150);
        setTimeout(()=>clearInterval(interval),4000);
      }
    })();
  </script>
</body>
</html>
